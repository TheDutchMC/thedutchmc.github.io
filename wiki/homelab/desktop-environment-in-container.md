# Linux XFCE4 Desktop Environment in Proxmox Container with GPU
Work in progress!


### Environment
Host OS: Proxmox
Container Template: Ubuntu 20.04 (Focal Fossa)
GPU: Nvidia GTX 1070

### Preparations
1. ``apt update && apt dist-upgrade -y``
2. ``reboot``
3. ``apt-get install sudo git gcc make pve-headers-$(uname -r)``

### Nvidia drivers on the host
1. ``mkdir /opt/nvidia``
2. ``cd /opt/nvidia``
3. ``wget https://us.download.nvidia.com/XFree86/Linux-x86_64/450.57/NVIDIA-Linux-x86_64-450.57.run``
4. ``chmod +x NVIDIA-Linux-x86_64-450.57.run``
5. ``./NVIDIA-Linux-x86_64-450.57.run --no-questions --ui=none --disable--nouveau
6. Verify that ``/etc/modprobe.d/nvidia-installer-disable-nouveau.conf`` contains:
```
#generated by nvidia-installer
blacklist nouveau
options nouveau modeset=0
```
7. ``reboot``
8. ``./NVIDIA-Linux-x86_64-450.57.run --no-questions --ui=none --disable--nouveau``
9. Verify that ``nvidia-smi`` works.
10. Edit ``/etc/modules-load.d/modules.conf``, add the following to it if it is not there yet:
```
nvidia
nvidia_uvm
```
11. ``update-initramfs -u``
12. Edit ``/etc/udev/rules.d/70-nvidia.rules`` so it contains the following:
```
# /etc/udev/rules.d/70-nvidia.rules
# Create /nvidia0, /dev/nvidia1 … and /nvidiactl when nvidia module is loaded
KERNEL=="nvidia", RUN+="/bin/bash -c '/usr/bin/nvidia-smi -L'"
#
# Create the CUDA node when nvidia_uvm CUDA module is loaded
KERNEL=="nvidia_uvm", RUN+="/bin/bash -c '/usr/bin/nvidia-modprobe -c0 -u'"
```
13. ``git clone https://github.com/NVIDIA/nvidia-persistenced.git``
14. ``cd nvidia-persistenced/init``
15. ``./install.sh``
16. Verify that Nvidia-persistenced is running: ``systemctl status nvidia-persistenced``
17. ``reboot``
18. ``ls -l /dev/nv*``
19. ``cd /opt/nvidia``
20. ``git clone https://github.com/keylase/nvidia-patch.git``
21. ``cd nvidia-patch``
22. ``./patch.sh``

### Creating the container
1. Create a container in the Proxmox gui. Do not start it yet
2. Edit ``/etc/pve/lxe/<CONTAINER ID>.conf``, add the following:
```
lxc.cgroup.devices.allow: c 195:* rwm
lxc.cgroup.devices.allow: c 235:* rwm
lxc.mount.entry: /dev/nvidia0 dev/nvidia0 none bind,optional,create=file
lxc.mount.entry: /dev/nvidiactl dev/nvidiactl none bind,optional,create=file
lxc.mount.entry: /dev/nvidia-uvm dev/nvidia-uvm none bind,optional,create=file
lxc.mount.entry: /dev/nvidia-modeset dev/nvidia-modeset none bind,optional,create=file
lxc.mount.entry: /dev/nvidia-uvm-tools dev/nvidia-uvm-tools none bind,optional,create=file
```

> **Note:** The IDs ``195`` and ``235`` come from ``ls -l /dev/nv*``

3. Start the container

### Nvidia drivers inside the container
1. ``mkdir /opt/nvidia``
2. ``cd /opt/nvidia``
3. ``wget https://us.download.nvidia.com/XFree86/Linux-x86_64/450.57/NVIDIA-Linux-x86_64-450.57.run``
4. ``chmod +x NVIDIA-Linux-x86_64-450.57.run``
5. ``./NVIDIA-Linux-x86_64-450.57.run --no-kernel-module --disable--nouveau
6. Verify that ``nvidia-smi`` works

### Installing the desktop environment
1. ``apt install -y xfce4 x2goserver x2goserver-xsession xfce4-terminal``  
2. ``sudo update-alternatives --config x-terminal-emulator`` Select the newly installed xfce4 terminal
3. On the client, run ``sudo apt install x2goClient``
4. On the client when creating a session, make sure it is set to xfce and not kde.
5. Done.


### [OpenGL] GLX Stuck at 1.2
When trying to run OpenGL applications I ran into an issue where GLX would be stuck at version 1.2, which is over 20 years old.  
1. ``apt install -y libxrandr-dev libxcb-randr0-dev python3 python3-setuptools python3-pip``
2. ``pip install Mako``
3. Download the latest Mesa version from mesa3d.org
4. Extract with ``tar -xvf <downloaded tar file>``
5. CD into your extracted tar
> **Note:** Commands after this point should be run as the root user
6. ``mkdir build``
7. ``cd build``
8. 
```bash
meson -D glx=gallium-xlib -D gallium-drivers=swrast -D platforms=x11 
-D dri3=enabled -D dri-drivers=“” -D vulkan-drivers=“” 
-D buildtype=release -D optimization=3
```
9. ``ninja``

> **Note:** Commands after this point should be run as the normal user

10. ``mkdir -p ~/libgl-xlib``
11. ``sudo cp src/gallium/targets/libgl-xlib/* ~/libgl-xlib``
12. Create a file in ``~/libgl-xlib/``, called ``x2goglx``
13. Paste in:
```bash
#!/bin/sh
export LD_LIBRARY_PATH=/home/tobias/libgl-xlib/libgl-xlib:${LD_LIBRARY_PATH} exec "$@"
```
14. ``sudo chown -R $USER:#!/bin/sh
108
export LD_LIBRARY_PATH=/home/<YOUR USERNAME HERE>/libgl-xlib/libgl-xlib:${LD_LIBRARY_PATH}$USER ~/libgl-xlib``
15. ``sudo chmod -R u+rwx ~/libgl-xlib``

16a. Run x2goglx so get GLX version 1.4
16b. Getting it to stick after boot is a WIP.

You may also have to run: ``sudo apt-get install mesa-common-dev libgl1-mesa-dev libglu1-mesa-dev``

